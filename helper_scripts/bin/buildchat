#!/usr/bin/env python

import typer
import jinja2
from pathlib import Path
from rdagent.utils.agent.tpl import T

tpl = """
ðŸ’» You are a helpful AI assistant.

ðŸ‘¤ 
You have a script like this:
```python
{{ code }}
```

It's according running stdout is:
```
{{ stdout }}
```

I want to understand how the prediction performance and labels are measured when creating the "score.csv".
Please give a clear and precise explanation using mathematical expressions.
"""

app = typer.Typer()


@app.command()
def explain_ws(code_fname: str = "main.py", stdout_fname: str = "stdout.txt"):
    # render template with provided code and stdout, then create a new file chat.md
    with open(code_fname, 'r') as cf:
        code_content = cf.read()
    with open(stdout_fname, 'r') as sf:
        stdout_content = sf.read()
    template = jinja2.Template(tpl)
    rendered = template.render(code=code_content, stdout=stdout_content)
    with open("chat.md", "w") as out_f:
        out_f.write(rendered)

@app.command()
def compare(
    curr_ws: Path = typer.Argument(..., help="Path to current workspace"),
    prev_ws: Path = typer.Argument(..., help="Path to previous workspace")
):
    curr_ws = Path(curr_ws)
    prev_ws = Path(prev_ws)
    with (curr_ws / "main.py").open() as cf:
        curr_code_content = cf.read()
    with (curr_ws / "stdout.txt").open() as cf:
        curr_stdout_content = cf.read()
    with (prev_ws / "main.py").open() as cf:
        prev_code_content = cf.read()
    with (prev_ws / "stdout.txt").open() as cf:
        prev_stdout_content = cf.read()
    chat_content = T(".buildchat:compare").r(curr_code=curr_code_content, curr_stdout=curr_stdout_content, prev_code=prev_code_content, prev_stdout=prev_stdout_content)
    with open("chat.md", "w") as out_f:
        out_f.write(chat_content)


if __name__ == "__main__":
    app()
