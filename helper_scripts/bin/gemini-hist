#!/usr/bin/env python
import json
import glob
import os
import pathlib

def extract_chat_history():
    """
    This script extracts chat history from the latest gemini session file
    and converts it into a bash script.
    """

    # Find the latest session file
    search_path = pathlib.Path.home().joinpath('.gemini', 'tmp', '**', 'chats', 'session-*.json')
    files = glob.glob(str(search_path), recursive=True)

    if not files:
        print("No session files found.")
        return

    latest_file = max(files, key=os.path.getmtime)
    print(f"Latest session file: {latest_file}")

    # Read the content of the latest session file
    with open(latest_file, 'r') as f:
        try:
            json_content = json.load(f)
        except json.JSONDecodeError:
            print(f"Error decoding JSON from {latest_file}")
            return

    script_content = ""
    if "messages" in json_content:
        for message in json_content["messages"]:
            if message.get("type") == "user":
                content = message.get('content', '')
                if len(content) > 200:
                    content = content[:200] + f" <.... {len(content) - 200} chars are truncated ...>"
                script_content += f"\n\ntrue << 'EOF'\n{content}\nEOF\n"
            elif message.get("type") == "gemini" and "toolCalls" in message:
                for tool_call in message["toolCalls"]:
                    args = tool_call.get("args", {})
                    if "command" in args:
                        script_content += f"{args['command']}\n"
                    elif "pattern" in args:
                        script_content += f"glob \"{args['pattern']}\"\n"
                    elif "file_path" in args:
                        script_content += f"cat \"{args['file_path']}\"\n"


    # Write the bash script
    output_filename = "gemini_history.sh"
    with open(output_filename, "w") as f:
        f.write(script_content)

    print(f"Bash script '{output_filename}' created successfully.")

if __name__ == "__main__":
    extract_chat_history()
